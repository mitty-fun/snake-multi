function showWords(e){for(var n=0;width>n;n++)for(var t=0;height>t;t++)n in e&&-1!=e[n].indexOf(t)?(ctx.fillStyle="white",ctx.fillRect(n*block,t*block,block-1,block-1)):(ctx.fillStyle="black",ctx.fillRect(n*block,t*block,block-1,block-1))}function draw(){for(var e=0;width>e;e++)for(var n=0;height>n;n++){switch(map[e][n]){case"empty":ctx.fillStyle=colors.empty;break;case"food":ctx.fillStyle=colors.food;break;case"wall":ctx.fillStyle=colors.wall;break;default:ctx.fillStyle=colors.body}ctx.fillRect(e*block,n*block,block-1,block-1)}}function keyevent(){if("playing"==status){var e,n=player1.head.x,t=player1.head.y,a=map[n][t];player1.next||(39==event.keyCode&&"left"!=a?e="right":37==event.keyCode&&"right"!=a?e="left":38==event.keyCode&&"down"!=a?e="up":40==event.keyCode&&"up"!=a&&(e="down")),e&&(clearTimeout(timer),changeDir(e,!0))}"gameOver"==status&&13==event.keyCode&&(showWords(logo),narrow(),status="menu")}function singoModStart(){role="",gameInit(),countdown(run)}function multiModStart(){role="host",gameInit()}function gameInit(e){if(map.createNewMap(logo),e){for(i=0;i<width;i++)map[i]=e.map[i];role="client",status="playing",player2=new snake({x:11,y:21},{x:11,y:24}),player1=new snake({x:31,y:21},{x:31,y:18}),player2.next="up",player1.next="down",round=0,sendEvents({event:"initDone"}),initDone()}else"host"==role?(player1=new snake({x:11,y:21},{x:11,y:24}),player2=new snake({x:31,y:21},{x:31,y:18}),player1.next="up",player2.next="down",map[11][21]="up",map[11][22]="up",map[11][23]="up",map[11][24]="up",map[31][21]="down",map[31][20]="down",map[31][19]="down",map[31][18]="down",map[20][20]="food",round=0,sendEvents({event:"gameInit",map:map})):(console.log("init game"),player1=new snake({x:20,y:21},{x:20,y:24}),player1.next="up",map[20][21]="up",map[20][22]="up",map[20][23]="up",map[20][24]="up",map.createFood())}function countdown(e){var n=0;this.count=function(){return showWords(number[n]),n++,n>=number.length?!0:void setTimeout("count()",1e3)},this.count(),setTimeout(e,5e3)}function run(){if(status="playing",role){draw();var e=player1.move(),n=player2.move();if(e||n)return status="gameOver",$("#enter").show(),sendEvents({event:"gameOver"}),0;prev=player1.next,player1.next="",player2.next="",round+=1}else{draw();var t=player1.move();if(t)return status="gameOver",$("#enter").show(),0;player1.next=""}timer=setTimeout("changeDir(map[player1.head.x][player1.head.y], true)",moveTime)}function changeDir(e,n){n?(player1.next=e,role&&sendEvents({event:"changeDir",dir:e,round:round})):e.round==round?player2.next=e.dir:sendEvents({event:lostReq}),role?player1.next&&player2.next&&run():player1.next&&run()}function connectInit(){your_peer_id=Math.floor(1e5*Math.random()).toString(),console.log("your ID number: "+your_peer_id),$("#your_number").text(your_peer_id),$("#another_number_input").keypress(function(e){code=e.keyCode?e.keyCode:e.which,13==code&&(another_peer_id=$(this).val(),$(this).val(""),connect())}),peer=new Peer(your_peer_id,{key:"ravoxvbzqf2sm7vi"}),peer.on("connection",function(e){e.on("data",function(e){handleEvents(e)})})}function connect(){console.log("connect to: "+another_peer_id),conn=peer.connect(another_peer_id),conn.on("open",function(){sendEvents({event:"connectReq",id:your_peer_id})})}function handleEvents(e){var n=JSON.parse(e),t=n.event;listener[t](n)}function sendEvents(e){conn.send(JSON.stringify(e))}function connectReq(e){another_peer_id=e.id,console.log("connect to: "+another_peer_id),conn=peer.connect(another_peer_id),conn.on("open",function(){multiModStart()})}function initDone(){countdown(run),expand()}function lostReq(){console.log("lost one"),sendEvents({event:"changeDir",dir:prev,round:round-1}),timer=setTimeout("changeDir(map[player1.head.x][player1.head.y], true)",moveTime)}function gameOver(){$("#enter").show(),status="gameOver"}function again(e){return e?player2_again=e.again:("host"==role&&(player1_again=!0),"client"==role&&(player1_again=!0,sendEvents({event:"again",again:!0}))),player1_again&&player2_again?(player1_again=!1,player2_again=!1,status="playing",expand(),gameInit()):void 0}function expand(){$(".menu-item").hide(),$("#canvasBox").animate({width:"533",height:"533"},800),$("canvas").animate({top:"0",left:"0"},800)}function narrow(){$("#canvasBox").animate({width:"208",height:"208"},800),$("canvas").animate({top:"-162.5",left:"-162.5"},800),$("#enter").hide(),$("#forTitan, #back").show()}var status="menu",role="",map=[],width=41,height=41,block=13,colors={wall:"#ff7834",food:"#3d41ca",body:"#fff",empty:"#000"},moveTime=100,timer,round,prev,cvs=document.getElementById("myCanvas"),ctx=cvs.getContext("2d"),player1,player2,player1_again,player2_again,logo={15:[15,17],17:[15,17],19:[15,17,19,21,23,25],21:[15,17,19,21,23,25],23:[15,17],25:[15,17]},number=[{18:[17,18,19,20,23],19:[17,20,23],20:[17,20,23],21:[17,20,23],22:[17,20,21,22,23]},{18:[17,18,19,20],19:[20],20:[20],21:[20],22:[17,18,19,20,21,22,23]},{18:[17,20,23],19:[17,20,23],20:[17,20,23],21:[17,20,23],22:[17,18,19,20,21,22,23]},{18:[17,20,21,22,23],19:[17,20,23],20:[17,20,23],21:[17,20,23],22:[17,18,19,20,23]},{20:[17,18,19,20,21,22,23]}];snake=function(e,n,t){this.next="",this.head=e,this.tail=n,this.body=t||1},snake.prototype.move=function(){var e=this.head.x,n=this.head.y,t=this.next,a="";switch(map[e][n]=t,t){case"up":if(0>n-1)return!0;a=map[e][n-1],map[e][n-1]="up",this.head.y-=1;break;case"left":if(0>e-1)return!0;a=map[e-1][n],map[e-1][n]="left",this.head.x-=1;break;case"right":if(e+1>width-1)return!0;a=map[e+1][n],map[e+1][n]="right",this.head.x+=1;break;case"down":if(n+1>height-1)return!0;a=map[e][n+1],map[e][n+1]="down",this.head.y+=1;break;default:return!0}if("empty"==a)this.moveTail();else{if("food"!=a)return console.log("gameOver"),!0;this.body+=1,map.createFood()}},snake.prototype.moveTail=function(){var e=this.tail.x,n=this.tail.y,t=map[e][n];switch(map[e][n]="empty",t){case"up":this.tail.y-=1;break;case"right":this.tail.x+=1;break;case"down":this.tail.y+=1;break;case"left":this.tail.x-=1}},map.createNewMap=function(e){for(var n=0;width>n;n++){this[n]=[];for(var t=0;height>t;t++)e&&e[n]&&-1!=e[n].indexOf(t)?this[n][t]="wall":this[n][t]="empty"}},map.createFood=function(e){if(e)map[e.x][e.y]="food",console.log(e);else if("host"==role){do var n=Math.floor(Math.random()*height),t=Math.floor(Math.random()*width);while("empty"!=map[n][t]);this[n][t]="food",sendEvents({event:"createFood",x:n,y:t})}if(!role){do var n=Math.floor(Math.random()*height),t=Math.floor(Math.random()*width);while("empty"!=map[n][t]);this[n][t]="food"}},document.onkeydown=keyevent;var your_peer_id,another_peer_id,peer,conn;$(document).ready(function(){showWords(logo),connectInit(),$(".menu-item").hide(),$(".menu-main").show(),$("#singo").on("click",function(){expand(),singoModStart()}),$("#multi").on("click",function(){another_peer_id?($("#another_number").text(another_peer_id),$(".menu-main").hide(),$("#again, #back").show(),again()):($(".menu-main").hide(),$(".menu-multi, #back").show(),$("#another_number_input").focus())}),$("#back").on("click",function(){$(".menu-item").hide(),$(".menu-main").show(),"client"==role&&sendEvents({event:"again",again:!1}),"host"==role&&(player1_again=!1)})});var listener={};listener.connectReq=connectReq,listener.gameInit=gameInit,listener.initDone=initDone,listener.changeDir=changeDir,listener.createFood=map.createFood,listener.gameOver=gameOver,listener.again=again,listener.lostReq=lostReq;