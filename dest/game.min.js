function showWords(e){for(var t=0;width>t;t++)for(var n=0;height>n;n++)t in e&&-1!=e[t].indexOf(n)?(ctx.fillStyle="white",ctx.fillRect(14*t,14*n,13,13)):(ctx.fillStyle="black",ctx.fillRect(14*t,14*n,13,13))}function draw(){for(var e=0;width>e;e++)for(var t=0;height>t;t++){switch(map[e][t]){case"empty":ctx.fillStyle=colors.empty;break;case"food":ctx.fillStyle=colors.food;break;case"wall":ctx.fillStyle=colors.wall;break;default:ctx.fillStyle=colors.body}ctx.fillRect(14*e,14*t,13,13)}}function keyevent(){if("playing"==status){var e,t=player1.head.x,n=player1.head.y,o=map[t][n];39!=event.keyCode||"left"==o||player1.next?37!=event.keyCode||"right"==o||player1.next?38!=event.keyCode||"down"==o||player1.next?40!=event.keyCode||"up"==o||player1.next||(e="down"):e="up":e="left":e="right",e&&(clearTimeout(timer),changeDir(e,!0),role&&sendEvents({event:"changeDir",dir:e}))}"gameOver"==status&&13==event.keyCode&&(showWords(logo),narrow(),status="menu")}function changeDir(e,t){t?(player1.next=e,role&&sendEvents({event:"changeDir",dir:e})):player2.next=e.dir,role?player1.next&&player2.next&&run():player1.next&&run()}function singoModStart(){role="",status="playing",gameInit(),countdown(run)}function multiModStart(){role="host",status="playing",gameInit()}function gameInit(e){if(map.createNewMap(logo),e){for(i=0;i<width;i++)map[i]=e.map[i];role="client",status="playing",player2=new snake({x:11,y:21},{x:11,y:24}),player1=new snake({x:31,y:21},{x:31,y:18}),sendEvents({event:"initDone"}),initDone()}else"host"==role?(player1=new snake({x:11,y:21},{x:11,y:24}),player2=new snake({x:31,y:21},{x:31,y:18}),map[11][21]="up",map[11][22]="up",map[11][23]="up",map[11][24]="up",map[31][21]="down",map[31][20]="down",map[31][19]="down",map[31][18]="down",map[20][20]="food",sendEvents({event:"gameInit",map:map})):(console.log("init game"),player1=new snake({x:20,y:21},{x:20,y:24}),map[20][21]="up",map[20][22]="up",map[20][23]="up",map[20][24]="up",map.createFood())}function countdown(e){var t=0;this.count=function(){return showWords(number[t]),t++,t>=number.length?!0:void setTimeout("count()",1e3)},this.count(),setTimeout(e,5e3)}function run(){if(role){draw();var e=player1.move();player2.move();if(e||e)return status="gameOver",$("#enter").show(),sendEvents({event:"gameOver"}),0;player1.next="",player2.next=""}else{draw();var t=player1.move();if(t)return status="gameOver",$("#enter").show(),0;player1.next=""}clearTimeout(timer),timer=setTimeout("changeDir(map[player1.head.x][player1.head.y], true)",moveTime)}function connectInit(){your_peer_id=Math.floor(1e6*Math.random()).toString(),console.log("your ID number: "+your_peer_id),$("#your_number").text(your_peer_id),$("#another_number").keypress(function(e){code=e.keyCode?e.keyCode:e.which,13==code&&(another_peer_id=$(this).val(),$(this).val(""),connect())}),peer=new Peer(your_peer_id,{key:"ravoxvbzqf2sm7vi"}),peer.on("connection",function(e){e.on("data",function(e){handleEvents(e)})})}function connect(){console.log("connect to: "+another_peer_id),conn=peer.connect(another_peer_id),conn.on("open",function(){sendEvents({event:"connectReq",id:your_peer_id})})}function handleEvents(e){var t=JSON.parse(e);console.log(t);var n=t.event;listener[n](t)}function sendEvents(e){conn.send(JSON.stringify(e))}function connectReq(e){another_peer_id=e.id,console.log("connect to: "+another_peer_id),conn=peer.connect(another_peer_id),conn.on("open",function(){multiModStart()})}function initDone(){countdown(run),expand()}function gameOver(){$("#enter").show(),status="gameOver"}function restart(){return again&&"host"==role?(status="playing",expand(),gameInit()):("client"==role&&sendEvents({event:"restart"}),void(again=!0))}function expand(){$(".menu-item").hide(),$("#canvasBox").animate({width:"574",height:"574"},800),$("canvas").animate({top:"0",left:"0"},800)}function narrow(){$("#canvasBox").animate({width:"224",height:"224"},800),$("canvas").animate({top:"-175",left:"-175"},800),$("#enter").hide(),$("#forTitan, #back").show()}var status="menu",role="",map=[],width=41,height=41,colors={wall:"#ff7834",food:"#3d41ca",body:"#fff",empty:"#000"},moveTime=100,timer,again=!1,cvs=document.getElementById("myCanvas"),ctx=cvs.getContext("2d"),player1,player2,logo={15:[15,17],17:[15,17],19:[15,17,19,21,23,25],21:[15,17,19,21,23,25],23:[15,17],25:[15,17]},number=[{18:[17,18,19,20,23],19:[17,20,23],20:[17,20,23],21:[17,20,23],22:[17,20,21,22,23]},{18:[17,18,19,20],19:[20],20:[20],21:[20],22:[17,18,19,20,21,22,23]},{18:[17,20,23],19:[17,20,23],20:[17,20,23],21:[17,20,23],22:[17,18,19,20,21,22,23]},{18:[17,20,21,22,23],19:[17,20,23],20:[17,20,23],21:[17,20,23],22:[17,18,19,20,23]},{20:[17,18,19,20,21,22,23]}];snake=function(e,t,n){this.next="",this.head=e,this.tail=t,this.body=n||1},snake.prototype.move=function(){var e=this.head.x,t=this.head.y,n=this.next?this.next:map[e][t],o="";switch(map[e][t]=n,n){case"up":if(0>t-1)return!0;o=map[e][t-1],map[e][t-1]="up",this.head.y-=1;break;case"left":if(0>e-1)return!0;o=map[e-1][t],map[e-1][t]="left",this.head.x-=1;break;case"right":if(e+1>width-1)return!0;o=map[e+1][t],map[e+1][t]="right",this.head.x+=1;break;case"down":if(t+1>height-1)return!0;o=map[e][t+1],map[e][t+1]="down",this.head.y+=1;break;default:return!0}if("empty"==o)this.moveTail();else{if("food"!=o)return console.log("gameOver"),!0;this.body+=1,map.createFood()}},snake.prototype.moveTail=function(){var e=this.tail.x,t=this.tail.y,n=map[e][t];switch(map[e][t]="empty",n){case"up":this.tail.y-=1;break;case"right":this.tail.x+=1;break;case"down":this.tail.y+=1;break;case"left":this.tail.x-=1}},map.createNewMap=function(e){for(var t=0;width>t;t++){this[t]=[];for(var n=0;height>n;n++)e&&e[t]&&-1!=e[t].indexOf(n)?this[t][n]="wall":this[t][n]="empty"}},map.createFood=function(e){if(e)map[e.x][e.y]="food",console.log(e);else if("host"==role){do var t=Math.floor(Math.random()*height),n=Math.floor(Math.random()*width);while("empty"!=map[t][n]);this[t][n]="food",sendEvents({event:"createFood",x:t,y:n})}if(!role){do var t=Math.floor(Math.random()*height),n=Math.floor(Math.random()*width);while("empty"!=map[t][n]);this[t][n]="food"}},document.onkeydown=keyevent;var your_peer_id,another_peer_id,peer,conn;$(document).ready(function(){showWords(logo),connectInit(),$(".menu-item").hide(),$(".menu-main").show(),$("#singo").on("click",function(){expand(),singoModStart()}),$("#multi").on("click",function(){another_peer_id?($("#another_peer_id").text(another_peer_id),$(".menu-main").hide(),$("#again, #back").show(),console.log("XD"),restart()):($(".menu-main").hide(),$(".menu-multi, #back").show(),$("#another_number").focus())}),$("#back").on("click",function(){$(".menu-item").hide(),$(".menu-main").show()})});var listener={};listener.connectReq=connectReq,listener.gameInit=gameInit,listener.initDone=initDone,listener.changeDir=changeDir,listener.createFood=map.createFood,listener.gameOver=gameOver,listener.restart=restart;